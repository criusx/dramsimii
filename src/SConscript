Import('*')
import shutil
import re

conf = Configure(env)

if not conf.CheckLib('boost_serialization'):
	print 'Boost serialization library not found, please install this.'
	print 'e.g. sudo apt-get install "libboost-serialization*"'
	Exit(1)
if not conf.CheckLib('boost_iostreams'):
	print 'Boost iostreams library not found, please install this.'
	print 'e.g. sudo apt-get install "libboost-iostreams*"'
	Exit(1)
if not conf.CheckCXXHeader('boost/circular_buffer.hpp'):
	print 'Need Boost 1.35 or newer with the circular buffer library.'
	print 'The circular buffer header files may also be copied from a newer Boost instance to an older one.'
	Exit(1)
if not conf.CheckLib('boost_thread'):
	print 'Boost thread library not found, please install this.'
	print 'e.g. sudo apt-get install "libboost-thread*"'
	Exit(1)
if not conf.CheckLib('boost_unit_test_framework'):
	print 'Boost unit test framework not found, please install this.'
	print 'e.g. sudo apt-get install "libboost-test*"'
	Exit(1)
if not conf.CheckLib('boost_signals'):
	print 'Boost signals library not found, please install this.'
	print 'e.g. sudo apt-get install "libboost-signals*"'
	Exit(1)
if not conf.CheckCXXHeader('vector'):
   print 'vector must be installed!'
   Exit(1)
if not conf.CheckLib('boost_filesystem'):
	print 'Boost filesystem library not found, please install this.'
	print 'e.g. sudo apt-get install "libboost-filesystem*"'
	Exit(1)
if not conf.CheckLib('boost_program_options'):
	print 'Boost program options library not found, please install this.'
	print 'e.g. sudo apt-get install libboost-program-options-dev*"'
	Exit(1)
#if not conf.CheckCHeader('xmlreader.h'):
#	print 'Missing xmlreader.h from libxml2'
#	Exit(1)
#if not conf.CheckCHeader('libxml2/libxml/parser.h'):
#	print 'Missing parser.h from libxml2'
#	Exit(1)
#if not conf.CheckCHeader('libxml2/libxml/tree.h'):
#	print 'Missing tree.h from libxml2'
#	Exit(1)
if not conf.CheckLib('xml2'):
	print 'libxml2 not found, please install this.'
	print 'e.g. sudo apt-get install "libxml2-*"'
	Exit(1)
#if not conf.CheckLib('gomp'):
#	print 'need a compiler that supports OpenMP.'
#	print 'such as gcc 4.2+, icc 11+, Visual Studio 2005+, etc.'
#	Exit(1)

#try:
#	env.Replace(CCFLAGS = env._dict['CCFLAGS'].remove('-Werror'))
#except ValueError:
#	pass

try:
	if 'fast' in re.split('[/.]',COMMAND_LINE_TARGETS[0]):
		print COMMAND_LINE_TARGETS[0]
		#defines = ['M5']
		#if (env.Dictionary() contains 'TRACE_GENERATE'):
		#	print "works"
		env.Append(
		# -funroll-all-loops -ffast-math -fprefetch-loop-arrays
			CCFLAGS = ['-I/usr/include/libxml2', '-fprefetch-loop-arrays','-ffast-math', '-funroll-all-loops', '-fomit-frame-pointer', '-Wuninitialized', '-Wno-conversion',
			# '-finline-functions', '-march=native','-Wno-unused-variable','-fprofile-generate', '-mtune=native']
			# '-finline-functions', '-march=native','-Wno-unused-variable','-fprofile-use', '-mtune=native']
			 '-finline-functions', '-march=native','-Wno-unused-variable', '-mtune=native']
			#,CPPDEFINES = ['M5', 'TRACE_GENERATE']
			,CPPDEFINES = ['M5']
			#,LINKFLAGS = ['-fprofile-use']
			#,LINKFLAGS = ['-fprofile-generate']
			)
	elif 'opt' in re.split('[/.]',COMMAND_LINE_TARGETS[0]):
		env.Append(
		CCFLAGS = ['-I/usr/include/libxml2', '-march=native', '-mtune=native'],
		#CPPDEFINES = ['M5DEBUG', 'DEBUG', 'M5', 'TRACE_GENERATE'])
		CPPDEFINES = ['M5DEBUG', 'DEBUG', 'M5', '__STDC_LIMIT_MACROS'])
	elif 'prof' in re.split('[/.]',COMMAND_LINE_TARGETS[0]):
		#print viableTargets
		env.Append(
			CCFLAGS = ['-I/usr/include/libxml2', '-funroll-loops',
			#'-Weffc++',
			#'-Wsign-compare',
			#'-Wdeprecated',
			'-ffast-math', '-finline-functions', '-march=native','-Wno-unused-variable']
			#,CPPDEFINES =
			 #['M5DEBUG']
			,CPPDEFINES = ['__STDC_LIMIT_MACROS']
			)
		try:
			env.Replace(CCFLAGS = env._dict['CCFLAGS'].remove('-g'))
		except ValueError:
			pass

	else:
		raise IndexError
except IndexError:
	# then this must be a debug build
	env.Append(
		CCFLAGS = ['-I/usr/include/libxml2'],
		CPPDEFINES = ['M5DEBUG', 'DEBUG', 'M5', '-__STDC_LIMIT_MACROS'])


SimObject('M5dramSystem.py')

Source('Address.cc')
Source('Bank.cc')
Source('command.cc')
Source('Channel.cc')
Source('event.cc')
Source('fbdAMB.cc')
Source('fbdChannel.cc')
Source('fbdFrame.cc')
Source('fbdSystem.cc')
Source('InputStream.cc')
Source('m5-dramSystem.cc')
Source('powerConfig.cc')
Source('Rank.cc')
Source('Settings.cc')
Source('SettingsXML.cc')
Source('simulationParameters.cc')
Source('Statistics.cc')
Source('System.cc')
Source('SystemConfiguration.cc')
Source('TimingSpecification.cc')
Source('transaction.cc')
Source('cache/cache.cc')

env = conf.Finish()

